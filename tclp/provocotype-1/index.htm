<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Get quick insights on your contracts</title>
  <meta name="description" content="">
  <link rel="icon" href="assets/img/favicon.svg">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <!-- lightbox -->
  <link rel="stylesheet" href="assets/css/fancybox.css" />
  <!-- Fathom - beautiful, simple website analytics -->
  <script src="https://cdn.usefathom.com/script.js" data-site="NLHUCFHP" defer></script>
  <!-- / Fathom -->
</head>

<body class=""><!-- use classes "vanilla" for minimal styling mode, or "animated" for changing background gradient -->
  <a class="skip-link" href="#main">Skip to content</a>

  <!-- loading screen -->
  <div id="loading-screen">
    <div class="loading-state playing">
      <div class="image"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="wave"></div>
      <div class="loading-inner-wrapper">
        <div class="loading-content-wrap" id="state-1">
          <span class="spinner"><img src="assets/img/loading-state-1.gif" /></span>
          <p><strong>Analysing contract</strong><p>
          <p>Scanning structure, text and metadata</p>
        </div>
        <div class="loading-content-wrap" id="state-2">
          <span class="spinner"><img src="assets/img/loading-state-2.gif" /></span>
          <p><strong>Finding relevant clauses</strong><p>
          <p>Matching content to legal topics</p>
        </div>
        <div class="loading-content-wrap" id="state-3">
          <span class="spinner"><img src="assets/img/loading-state-3.gif" /></span>
          <p><strong>Preparing report</strong><p>
          <p>Ranking insights and formatting your summary</p>
        </div>
      </div>
    </div>
    <div class="bg-grad"></div>
  </div>
  <!-- end loading screen -->

  <header class="site-header row" role="banner">
    <div class="container">
      <h1 class="site-title">
        <img src="assets/img/logo-white.svg" class="white" />
        <img src="assets/img/logo.svg" class="blue" />
      </h1>
      <!--
      <nav aria-label="Primary" class="site-nav">
        <a class="btn" href="https://chancerylaneproject.org/" target="_blank">Main site</a>
      </nav> -->
    </div>
  </header>

  <main id="main" class="site-main row" role="main">
    <section class="container">
      <div class="home-actions">
        <h2>Get fast insights on your contracts to reduce emissions</h2>
      </div>

        <div class="select-contract">
          <form action="index2.htm" method="get" id="analysisForm">
          <div class="govuk-form-group" id="analysis-group">
            <fieldset class="govuk-fieldset"aria-describedby="analysis-hint analysis-error">
              <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                <p id="analysis-hint" class="govuk-fieldset__heading">
                  Try with a sample contract or upload your own:
                </p>
              </legend>

              <!-- Inline error message (hidden by default) -->
              <p class="govuk-error-message" id="analysis-error" hidden>
                <span class="govuk-visually-hidden">Error:</span> Select a contract to analyse or upload your own.
              </p>

              <div class="govuk-radios" data-module="govuk-radios">

                <div class="govuk-radios__item">
                  <input class="govuk-radios__input" id="Contract1" name="Contract" type="radio" value="Total Facilities Management Agreement (TFMA).DOCX" aria-describedby="Contract1-item-hint">
                  <label class="govuk-label govuk-radios__label" for="Contract1">
                    <span>Total Facilities Management Agreement (TFMA).DOCX</span>
                    <div id="Contract1-item-hint" class="govuk-hint govuk-radios__hint">
                      <span><strong>Sector: </strong><br />Public sector</span>
                      <span><strong>Subject matter: </strong><br />Service Level Agreement</span>
                      <span><a data-fancybox data-type="iframe" data-type="ajax" data-src="assets/sample-contracts/contract-1.html">Preview contract</a></span>
                    </div>
                  </label>
                </div>

                <div class="govuk-radios__item">
                  <input class="govuk-radios__input" id="Contract2" name="Contract" type="radio" value="NEC4 Engineering and Construction Contract.PDF" aria-describedby="Contract2-item-hint">
                  <label class="govuk-label govuk-radios__label" for="Contract2">
                    <span>NEC4 Engineering and Construction Contract.PDF</span>
                    <div id="Contract2-item-hint" class="govuk-hint govuk-radios__hint">
                      <span><strong>Sector: </strong><br />Construction</span>
                      <span><strong>Subject matter: </strong><br />Construction Contract</span>
                      <span><a data-fancybox data-type="iframe" data-type="ajax" data-src="assets/sample-contracts/contract-2.html">Preview contract</a></span>
                    </div>
                  </label>
                </div>

                <div class="govuk-radios__item">
                  <input class="govuk-radios__input" id="Contract3" name="Contract" type="radio" value="Loan Market Association (LMA) Facility Agreement.DOC" aria-describedby="Contract3-item-hint">
                  <label class="govuk-label govuk-radios__label" for="Contract3">
                    <span>Loan Market Association (LMA) Facility Agreement.DOC</span>
                    <div id="Contract3-item-hint" class="govuk-hint govuk-radios__hint">
                      <span><strong>Sector: </strong><br />Banking and finance</span>
                      <span><strong>Subject matter: </strong><br />Loan Agreement</span>
                      <span><a data-fancybox data-type="iframe" data-type="ajax" data-src="assets/sample-contracts/contract-3.html">Preview contract</a></span>
                    </div>
                  </label>
                </div>

                <div class="govuk-radios__item">
                  <input class="govuk-radios__input" id="Contract4" name="Contract" type="radio" value="Software-as-a-Service (SaaS) Agreement.DOC" aria-describedby="Contract4-item-hint">
                  <label class="govuk-label govuk-radios__label" for="Contract4">
                    <span>Software-as-a-Service (SaaS) Agreement.DOC</span>
                    <div id="Contract4-item-hint" class="govuk-hint govuk-radios__hint">
                      <span><strong>Sector: </strong><br />Technology</span>
                      <span><strong>Subject matter: </strong><br />Software licensing & services</span>
                      <span><a data-fancybox data-type="iframe" data-type="ajax" data-src="assets/sample-contracts/contract-4.html">Preview contract</a></span>
                    </div>
                  </label>
                </div>

                <div class="govuk-radios__item upload">
                  <input class="govuk-radios__input" id="Contract5" name="Contract" type="radio" value="Uploaded contract" aria-describedby="Upload-item-hint">
                  <label class="govuk-label govuk-radios__label" for="Contract5">
                    <span>Upload your own contract</span>
                    <div id="Contract5-item-hint" class="govuk-hint govuk-radios__hint">
                      <span><strong>Accepted files: </strong><br />TXT, PDF, DOCX, MD</span>
                      <span><strong>Max file size: </strong><br />10MB</span>
                    </div>
                  </label>
                  <div class="upload">
                    <input id="file" class="upload__input" type="file" accept=".txt,.pdf,.docx,.doc,.md,text/plain,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/msword,text/markdown" />
                    <label for="file" class="upload__btn">Choose file</label>
                    <span class="upload__filename" aria-live="polite"></span>
                  </div>
                </div>



              </div>
            </fieldset>
          </div>
          <button id="getInsights" type="submit" class="yellow">Get insights</button>
        </form>

      </div>
    </section>
  </main>

  <footer class="site-footer row" role="contentinfo">
    <div class="container">
    </div>
  </footer>

  <div class="bg-grad"></div>

  <!-- lightbox -->
  <script src="assets/js/fancybox.umd.js"></script>
  <script>
    // Set a flag to indicate we're using backend processing (prevents static timer)
    window.USE_BACKEND_PROCESSING = true;
  </script>
  <script src="assets/js/main.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const fileInput = document.getElementById('file');
      const filenameEl = document.querySelector('.upload__filename');
      const uploadRadio = document.getElementById('Contract5');
      const form = document.getElementById('analysisForm');

      if (fileInput) {
        fileInput.addEventListener('change', function () {
          const file = fileInput.files && fileInput.files[0];
          if (!file) return;
          const name = file.name;

          if (filenameEl) filenameEl.textContent = name;
          if (uploadRadio) {
            uploadRadio.value = name; // submit actual filename as Contract value
            uploadRadio.checked = true; // ensure this option is selected
          }
          try { sessionStorage.setItem('contractName', name); } catch (e) {}
        });
      }

      // Loading screen functionality
      const loadingScreen = document.getElementById('loading-screen');
      let loadingInterval = null;

      function showLoadingScreen() {
        if (loadingScreen) {
          loadingScreen.classList.add('active');
          startLoadingStates();
        }
      }

      function hideLoadingScreen() {
        if (loadingScreen) {
          loadingScreen.classList.remove('active');
          if (loadingInterval) {
            clearInterval(loadingInterval);
            loadingInterval = null;
          }
        }
      }

      function startLoadingStates() {
        const states = document.querySelectorAll('.loading-content-wrap');
        if (!states.length) return;

        let current = 0;
        states.forEach(s => s.classList.remove('active', 'fade-out'));
        states[current].classList.add('active');

        loadingInterval = setInterval(() => {
          states[current].classList.remove('active');
          states[current].classList.add('fade-out');

          const next = (current + 1) % states.length;

          setTimeout(() => {
            states[current].classList.remove('fade-out');
            states[next].classList.add('active');
            current = next;
          }, 600);
        }, 4000);
      }

      // Handle form submission for backend processing
      const handleFormSubmit = async function (e) {
        e.preventDefault();
        e.stopPropagation(); // Prevent any other handlers from running

          const selected = document.querySelector('input[name="Contract"]:checked');
          const hasFile = fileInput && fileInput.files && fileInput.files[0];

          // Validate before showing loading screen
          if (!hasFile && (!selected || selected.id === 'Contract5')) {
            alert('Please upload a file or choose a sample contract.');
            return;
          }

          // Show loading screen after validation passes
          showLoadingScreen();

          // Determine what we're processing and create a file-like object
          let fileToProcess = null;
          let displayName = 'Contract';

          if (hasFile) {
            // User uploaded a file
            fileToProcess = fileInput.files[0];
            displayName = fileToProcess.name;
          } else if (selected && selected.id && selected.id.startsWith('Contract') && selected.id !== 'Contract5') {
            // Sample contract selected - fetch content and create file-like object
            try {
              const id = selected.id || '';
              const m = id.match(/^Contract(\d+)$/);
              if (!m) throw new Error('Invalid sample contract selection.');
              const num = m[1];
              const sampleUrl = `assets/sample-contracts/contract${num}.txt`;

              const resp = await fetch(sampleUrl);
              if (!resp.ok) throw new Error('Failed to load sample contract.');
              const html = await resp.text();
              const tmp = document.createElement('div');
              tmp.innerHTML = html;
              const text = tmp.textContent || tmp.innerText || '';

              // Create a file-like object from the text
              const blob = new Blob([text], { type: 'text/plain' });
              fileToProcess = new File([blob], `${selected.value}.txt`, { type: 'text/plain' });
              displayName = selected.value;
            } catch (err) {
              console.error('Error preparing sample contract:', err);
              hideLoadingScreen();
              alert('There was a problem preparing the sample contract. ' + (err && err.message ? err.message : ''));
              return;
            }
          } else {
            // No file uploaded and no sample selected
            hideLoadingScreen();
            alert('Please upload a file or choose a sample contract.');
            return;
          }

          // Validate file type
          const allowedExtensions = ['.txt', '.pdf', '.docx', '.doc', '.md'];
          const fileExtension = '.' + fileToProcess.name.split('.').pop().toLowerCase();
          if (!allowedExtensions.includes(fileExtension)) {
            hideLoadingScreen();
            alert(`Only ${allowedExtensions.join(', ')} files are supported.`);
            return;
          }

          // Single processing flow for both uploaded files and sample contracts
          try {
            const formData = new FormData();
            formData.append('file', fileToProcess, fileToProcess.name);

            // Submit and get task ID
            const resp = await fetch('process/', { method: 'POST', body: formData });
            if (!resp.ok) {
              const errTxt = await resp.text();
              throw new Error(errTxt || 'Request failed');
            }
            const { task_id } = await resp.json();
            console.log('Processing task ID:', task_id);

            // Poll for completion
            const pollTask = async () => {
              const statusResp = await fetch(`task/${task_id}`);
              if (!statusResp.ok) {
                throw new Error('Failed to check task status');
              }
              const taskStatus = await statusResp.json();
              console.log('Task status:', taskStatus.status, 'Progress:', taskStatus.progress);

              if (taskStatus.status === 'completed') {
                // Processing complete - use the result
                const data = taskStatus.result;
                console.log('Processing completed:', data);

                // Call /find_clauses/ endpoint with async polling
                let recommendResult = null;
                try {
                  const clauseFormData = new FormData();
                  clauseFormData.append('file', fileToProcess, fileToProcess.name);
                  
                  // Submit and get task ID
                  const clauseResp = await fetch('find_clauses/', { method: 'POST', body: clauseFormData });
                  console.log('Clause response status:', clauseResp.status);
                  
                  if (!clauseResp.ok) {
                    const errTxt = await clauseResp.text();
                    console.error('Clause detection failed:', errTxt);
                    throw new Error(errTxt || 'Clause detection failed');
                  }
                  
                  const { task_id: clauseTaskId } = await clauseResp.json();
                  console.log('Clause task ID:', clauseTaskId);
                  
                  // Poll for clause results
                  const pollClauseTask = async () => {
                    const statusResp = await fetch(`task/${clauseTaskId}`);
                    if (!statusResp.ok) {
                      throw new Error('Failed to check clause task status');
                    }
                    const taskStatus = await statusResp.json();
                    console.log('Clause task status:', taskStatus.status, 'Progress:', taskStatus.progress);
                    
                    if (taskStatus.status === 'completed') {
                      recommendResult = taskStatus.result;
                      console.log('Clause detection completed:', recommendResult);
                      return; // Exit polling
                    } else if (taskStatus.status === 'failed') {
                      throw new Error(taskStatus.error || 'Clause detection failed');
                    } else {
                      // Still processing - poll again in 2 seconds
                      await new Promise(resolve => setTimeout(resolve, 2000));
                      await pollClauseTask(); // Continue polling
                    }
                  };
                  
                  // Start polling and wait for completion
                  await pollClauseTask();
                  
                } catch (e) {
                  console.error('Error in find_clauses:', e);
                  recommendResult = null;
                }

                // Store results in sessionStorage (only if not null)
                try {
                  if (recommendResult) {
                    sessionStorage.setItem('recommendResult', JSON.stringify(recommendResult));
                  }
                } catch (e) {
                }

                try {
                  sessionStorage.setItem('processResult', JSON.stringify(data));
                  sessionStorage.setItem('contractName', displayName);
                } catch (e) {
                  console.error('Error storing processResult:', e);
                }

                // Navigate to report page (loading screen will be hidden on navigation)
                window.location.href = 'index2.htm';

              } else if (taskStatus.status === 'failed') {
                throw new Error(taskStatus.error || 'Processing failed');
              } else {
                // Still processing - poll again in 2 seconds
                setTimeout(pollTask, 2000);
              }
            };

            // Start polling
            await pollTask();

          } catch (err) {
            console.error('Error in form submission:', err);
            hideLoadingScreen();
            alert('There was a problem processing your contract. ' + (err && err.message ? err.message : ''));
          }
        };

      // Attach to both form submit and button click to ensure it runs
      if (form) {
        form.addEventListener('submit', handleFormSubmit);
      }
      const submitButton = document.getElementById('getInsights');
      if (submitButton) {
        submitButton.addEventListener('click', handleFormSubmit);
      }
    });
  </script>

</body>
</html>
