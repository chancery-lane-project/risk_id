<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Get quick insights on your contracts</title>
  <meta name="description" content="">
  <link rel="icon" href="assets/img/favicon.svg">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <!-- lightbox -->
  <link rel="stylesheet" href="assets/css/fancybox.css" />

  <script>
    // Handler #1: processResult (classification + highlighted link + contract title)
    document.addEventListener('DOMContentLoaded', function () {
      const params = new URLSearchParams(window.location.search);
      const contractName =
        params.get('contract') ||
        params.get('Contract') ||
        sessionStorage.getItem('contractName'); // if you used sessionStorage earlier

      const titleEl = document.getElementById('contract-title');
      if (titleEl && contractName) {
        titleEl.textContent = contractName;
      }

      // Load process result (classification + highlighted URL)
      try {
        const raw = sessionStorage.getItem('processResult');
        if (raw) {
          const data = JSON.parse(raw);

          // Update score label (basic example)
          const scoreEls = document.querySelectorAll('.score-overview');
          scoreEls.forEach(el => el.classList.remove('active'));
          const map = {
            'unlikely': 'none',
            'possible': 'basic',
            'likely': 'moderate',
            'very likely': 'strong'
          };
          const cls = map[(data.classification || '').toLowerCase()] || 'none';
          const target = document.querySelector('.score-overview.' + cls);
          if (target) target.classList.add('active');

          // Add link to highlighted output if available
          const p = document.querySelector('.context');
          if (p && data.highlighted_output_url) {
            const a = document.createElement('a');
            a.href = data.highlighted_output_url;
            a.setAttribute('data-fancybox', '');
            a.setAttribute('data-type', 'ajax');
            a.setAttribute('data-src', data.highlighted_output_url);            
            a.textContent = 'View analysis';
            p.appendChild(document.createElement('br'));
            p.appendChild(document.createTextNode(' '));
            p.appendChild(a);
            
            // Bind fancybox to the newly created element
            // Use setTimeout to ensure fancybox is fully loaded
            setTimeout(() => {
              if (typeof Fancybox !== 'undefined') {
                Fancybox.bind(a, {
                  groupAll: false
                });
              }
            }, 100);
          }
        }
      } catch (e) {
        // ignore
      }
    });
  </script>
</head>

<body class=""><!-- use classes "vanilla" for minimal styling mode, or "animated" for changing background gradient -->
  <a class="skip-link" href="#main">Skip to content</a>

  <header class="site-header row" role="banner">
    <div class="container">
      <h1 class="site-title">
        <img src="assets/img/logo-white.svg" class="white" alt="Logo white"/>
        <img src="assets/img/logo.svg" class="blue" alt="Logo"/>
      </h1>
      <!--
      <nav aria-label="Primary" class="site-nav">
        <a class="btn" href="https://chancerylaneproject.org/" target="_blank" rel="noopener noreferrer">Main site</a>
      </nav> -->
    </div>
  </header>

  <main id="main" class="site-main row" role="main">
    <section class="container">
      <div class="row report">

        <section class="summary">
          <div class="govuk-phase-banner">
            <p class="govuk-phase-banner__content">
              <strong class="govuk-tag govuk-phase-banner__content__tag">Alpha</strong>
              <span class="govuk-phase-banner__text">
                Learn how to reduce emissions and build climate resilience in a contract
              </span>
            </p>
          </div>

          <h2 id="contract-title">[Contract name will go here]</h2>

          <div class="row meta-data-summary">
            <span>
              <strong>Sector:</strong><br />
              Public Sector
            </span>
            <span>
              <strong>Subject matter:</strong><br />
              Service Level Agreement
            </span>
            <span>
              <strong>Content:</strong><br />
              5 pages / 3,116 words
            </span>
            <span>
              <strong>Analysis time:</strong><br />
              5 seconds
            </span>
          </div>

          <div class="row scoring">
            <div class="col score-summary">
              <p class="score-overview none">None</p>
              <p class="score-overview basic">BASIC</p>
              <p class="score-overview moderate">Moderate</p>
              <p class="score-overview strong">Strong</p>

              <p class="context">
                <strong>Climate-aligned language detected</strong><br/>
                Some climate-aligned clauses included and mentions of carbon footprint.
              </p>
            </div>

            <div class="col quant-summary">
              <p><strong id="clause-count">0</strong> Recommended clauses</p>
            </div>
            <div class="col quant-summary">
              <!-- Add stable id so JS can update reliably (replaces brittle text==='2' check) -->
              <p><strong id="emissions-count">2</strong> Possible emissions addressed</p>
            </div>
          </div>
        </section>

        <section class="row">
          <h2>Recommended clauses to review</h2>
          <div class="row clause-stack" id="recommendation-list">
            <!-- Clauses will be dynamically inserted here by JS below -->
            <noscript>
              <article class="clause">
                <div class="row clause-inner">
                  <p class="child-name">[Child name]</p>
                  <h3 class="clause-title">[Clause title]</h3>
                  <p class="clause-excerpt">
                    [Clause excerpt/summary]
                  </p>
                  <time><strong>Updated:</strong> [Date]</time>
                </div>
                <div class="row clause-toggle">
                  <h4>Show emissions and how they're addressed</h4>
                  <div class="row clause-toggle-inner">
                    <table>
                      <thead>
                        <tr>
                          <th scope="col">Emissions source</th>
                          <th scope="col">How itâ€™s addressed</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>[Source]</td>
                          <td>[How addressed]</td>
                        </tr>
                      </tbody>
                    </table>
                    <div class="row"><a href="#" class="btn sml" target="_blank">View clause full text</a></div>
                  </div>
                </div>
              </article>
            </noscript>
          </div>
        </section>

      </div>
    </section>
  </main>

  <footer class="site-footer row" role="contentinfo">
    <div class="container">
    </div>
  </footer>

  <div class="bg-grad"></div>

  <!-- lightbox -->
  <script src="assets/js/fancybox.umd.js"></script>
  <script src="assets/js/main.js" defer></script>

  <script>
    // Handler #2: recommendResult (recommended clauses list + counts)
    document.addEventListener('DOMContentLoaded', function() {

      // Load recommendations from sessionStorage
      try {
        const raw = sessionStorage.getItem('recommendResult');

        if (raw) {
          const data = JSON.parse(raw);
          const list = document.getElementById('recommendation-list');

          if (list && data.matches && data.matches.length > 0) {
            // Clear any existing content and replace with real recommendations
            list.innerHTML = '';

            // Count unique emission labels across all matches and count actual clauses
            const allEmissionLabels = new Set();
            let actualClauseCount = 0;

            data.matches.forEach(match => {
              actualClauseCount++; // Count each match as a clause
              if (match.emissions_sources && match.emissions_sources.length > 0) {
                match.emissions_sources.forEach(emission => {
                  if (emission.emission_label && emission.emission_label !== 'N/A' && emission.emission_label !== '') {
                    allEmissionLabels.add(emission.emission_label);
                  }
                });
              }
            });

            const uniqueEmissionLabelCount = allEmissionLabels.size;

            // Update the clause count in the summary section
            const clauseCountElement = document.getElementById('clause-count');
            if (clauseCountElement) {
              clauseCountElement.textContent = String(actualClauseCount);
            } else {
              // Fallback: find by text content (kept for backward-compat)
              const allStrongElements = document.querySelectorAll('.quant-summary p strong');
              allStrongElements.forEach(element => {
                if (element.parentElement && element.parentElement.textContent.includes('Recommended clauses')) {
                  element.textContent = String(actualClauseCount);
                }
              });
            }

            // Update the emissions count in the summary section (robust id-based update)
            const emissionsCountElement = document.getElementById('emissions-count');
            if (emissionsCountElement) {
              emissionsCountElement.textContent = String(uniqueEmissionLabelCount);
            } else {
              // Backwards-compat fallback (brittle path retained but no longer primary)
              const summaryElements = document.querySelectorAll('.quant-summary p strong');
              summaryElements.forEach(element => {
                if (element.textContent === '2' && element.parentElement && element.parentElement.textContent.includes('Possible emissions addressed')) {
                  element.textContent = String(uniqueEmissionLabelCount);
                }
              });
            }

            // Render each recommendation
            data.matches.forEach((m) => {
              const article = document.createElement('article');
              article.className = 'clause';
              article.innerHTML = `
                <div class="row clause-inner">
                  ${m.child_name ? `<p class="child-name">${m.child_name}</p>` : ''}
                  <h3 class="clause-title">${m.name || 'Unnamed clause'}</h3>
                  <p class="clause-excerpt"><strong>Why this clause:</strong> ${m.reason || 'No reason available'}</p>
                </div>
                <div class="row clause-toggle">
                  <h4>Show emissions and how they're addressed</h4>
                  <div class="row clause-toggle-inner">
                    ${m.emissions_sources && m.emissions_sources.length > 0 ? `
                      <div class="emissions-table-container">
                        <table class="emissions-table">
                          <thead>
                            <tr>
                              <th>Emission Source</th>
                              <th>Justification</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${m.emissions_sources.map(emission => `
                              <tr>
                                <td>${emission.emission_label || 'N/A'}</td>
                                <td>${emission.justification || 'N/A'}</td>
                              </tr>
                            `).join('')}
                          </tbody>
                        </table>
                      </div>
                    ` : '<p><strong>Climate emissions sources addressed:</strong> No specific emissions sources identified</p>'}
                    <div class="row"><a href="#" class="btn sml" target="_blank">View clause full text</a></div>
                  </div>
                </div>
              `;
              list.appendChild(article);
            });
          } else {
            // If no recommendations, show a message
            const listEl = document.getElementById('recommendation-list');
            if (listEl) {
              listEl.innerHTML = '<p>No specific clauses were recommended for this contract.</p>';
            }
          }
        } else {
          // If no recommendResult in sessionStorage, show a message
          const list = document.getElementById('recommendation-list');
          if (list) {
            list.innerHTML = '<p>No recommendations available. Please try uploading a contract or selecting a sample.</p>';
          }
        }
      } catch (e) {
        console.error('Error loading recommendations:', e);
        console.error('Error details:', e.message);
        console.error('Error stack:', e.stack);
        // Show error message with more details
        const list = document.getElementById('recommendation-list');
        if (list) {
          list.innerHTML = `<p>Error loading recommendations: ${e.message}. Please try again.</p>`;
        }
        // Also update the clause count to show 0
        const clauseCountElement = document.getElementById('clause-count');
        if (clauseCountElement) {
          clauseCountElement.textContent = '0';
        }
      }
    });
  </script>

</body>
</html>
